{{- if not .Values.secrets.externalSecrets.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "gharts.fullname" . }}-secret
  labels:
    {{- include "gharts.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database URL with password
  {{- if .Values.postgresql.enabled }}
  DATABASE_URL: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "gharts.database.host" . }}:{{ include "gharts.database.port" . }}/{{ include "gharts.database.name" . }}"
  {{- else }}
  DATABASE_URL: "postgresql://{{ .Values.externalDatabase.username }}:{{ .Values.externalDatabase.password }}@{{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }}/{{ .Values.externalDatabase.database }}?sslmode={{ .Values.externalDatabase.sslMode }}"
  {{- end }}

  # Bootstrap admin password
  {{- if .Values.config.bootstrap.enabled }}
  BOOTSTRAP_ADMIN_PASSWORD: {{ .Values.config.bootstrap.password | quote }}
  {{- end }}

---
# Separate secret for GitHub App private key (mounted as file)
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "gharts.fullname" . }}-github-key
  labels:
    {{- include "gharts.labels" . | nindent 4 }}
type: Opaque
stringData:
  private-key.pem: |
{{ .Values.config.github.privateKey | indent 4 }}
{{- end }}

# Made with Bob
